# 2025-10-08T07:36:29Z - Boot image VM follow-up

## Context
- Goal: confirm that the `_systemctl(..., ignore_missing=True)` changes and module tweaks unblock provisioning/networking.
- Action: reran `pytest tests/test_boot_image_vm.py` on the freshly modified tree (root key generated by the fixture).

## Observations
- `nix build .#bootImage --impure --no-link --print-out-paths` (with `PRE_NIXOS_ROOT_KEY` pointing at `/tmp/pytest-of-root/pytest-4/boot-image-ssh-key0/id_ed25519.pub`) returned `/nix/store/4hsa8bvg3d073am0pp9ajv056rhqsfr4-nixos-24.05.20241230.b134951-x86_64-linux.iso`.
- Both VM tests failed:
  - `test_boot_image_provisions_clean_disk` saw `command -v` report `MISSING` for `disko`, `lsblk`, and `wipefs` and never reached the provisioning assertions.
  - `test_boot_image_configures_network` timed out waiting for IPv4 on `lan` (no DHCP assignment, SSH unreachable).
- Serial log (`docs/boot-logs/2025-10-08T07-36-29Z-serial.log`) still shows `pre-nixos: Provisioning failed` immediately after the login banner.
- Unlike the previous diagnostic run, the journal output was not captured automatically (the test aborted before fetching it), so the exact stack trace is unknown.

## Immediate hypotheses
1. The ISO rebuild might still be picking up an older derivation (even though the `pre_nixos/network.py` in the store contains `_systemctl`). Need to confirm via `journalctl` whether `systemd-networkd` restart is being skipped or still raising exit code 5 for a different reason.
2. The fixture could be caching the ISO path (`4hsa...`) across runs without forcing a rebuild when the root key changes, although `--print-out-paths` suggests the new key is embedded. Logging the resolved store path will make future comparisons easier.
3. Provisioning may now be failing earlier (before tool availability) which triggers the `command -v` assertions; capturing the journal should reveal whether `configure_lan` or storage detection is raising.

## Next steps
- Teach the `boot_image_iso` fixture (or the tests) to log the resolved store path and copy `journalctl -u pre-nixos.service -b` whenever provisioning aborts.
- Re-run the VM test once the diagnostics hooks are in place to see the new stack trace.
- If the journal confirms `_systemctl(..., ignore_missing=True)` is executing, analyse why the systemd restart still fails (e.g., unit masked, wrong target, or networkd not enabled despite module changes).
