# Boot-image VM debug session (2025-10-12T02:04:19Z)

## Context
- Built the boot image via `nix build .#bootImage` after installing `pexpect`, then reran `pytest tests/test_boot_image_vm.py -vv --boot-image-debug` to reproduce the provisioning hang with full logging. The test aborted with `pre-nixos` still activating and timed out before collecting storage status, triggering the fixture's interactive shell hooks. 【8c8cf2†L1-L13】【78f14a†L1-L8】【377114†L1-L2】【138e6e†L1-L120】
- Captured the resulting debug artifacts under `docs/work-notes/2025-10-12T02-04-19Z-boot-image-vm-debug-session/`, including the VM serial transcript and harness log generated by an auxiliary automation script. The script reused the freshly built ISO (`metadata.json`) to rerun the VM, execute the required inspection commands, and archive their outputs. 【ea456b†L1-L11】

## Findings
- `pre-nixos.service` remained in `activating` state 17 seconds into the run while holding PID 739 (`pre-nixos-start`). The journal shows the helper invoking `systemctl start sshd` but never reaching an `inactive` or `failed` status before the harness timed out. 【F:docs/work-notes/2025-10-12T02-04-19Z-boot-image-vm-debug-session/serial.log†L40-L63】
- The structured journal entries confirm the LAN helper repeatedly brought `ens4` up, renamed it to `lan`, applied networkd configuration, and launched `sshd`. There were no carrier errors; every low-level command succeeded. 【F:docs/work-notes/2025-10-12T02-04-19Z-boot-image-vm-debug-session/serial.log†L53-L93】
- `networkctl status lan` reported the interface as `routable` with DHCP lease `10.0.2.15/24`, gateway `10.0.2.2`, and DNS `10.0.2.3`, confirming systemd-networkd provisioned the link even though the harness still waited for `pre_nixos` to emit storage status. 【F:docs/work-notes/2025-10-12T02-04-19Z-boot-image-vm-debug-session/serial.log†L94-L131】
- `/run/pre-nixos/storage-status` was absent (the command returned no content), matching the original pytest failure that blocked on storage detection. 【F:docs/work-notes/2025-10-12T02-04-19Z-boot-image-vm-debug-session/serial.log†L94-L95】
- `ip -o link` emitted no additional lines beyond the prompt in this capture, consistent with the harness seeing no output before continuing. All link characteristics (MAC, MTU, QDisc) were nevertheless recorded through `networkctl`. 【F:docs/work-notes/2025-10-12T02-04-19Z-boot-image-vm-debug-session/serial.log†L64-L105】

## Artifacts
- `serial.log`, `harness.log`, and command transcripts reside in `docs/work-notes/2025-10-12T02-04-19Z-boot-image-vm-debug-session/` for further analysis.
- `metadata.json` captures the exact ISO store path, derivation, NAR hash, and embedded root key fingerprint used for this session. 【ea456b†L1-L11】
