# VM split progress â€” 2025-12-21T220149Z (UTC)

## Summary
- Captured a fixture/helper inventory from `tests/test_boot_image_vm.py` to guide the migration.
- Chose a `tests/vm/conftest.py` shim to re-export fixtures during the split.
- Wrote the concrete RAID/LVM residue recipe and expectations for the regression scenario.

## Inventory snapshot (tests/test_boot_image_vm.py)
| Item | Scope | Target module |
| --- | --- | --- |
| `_pexpect` | Session fixture ensuring `pexpect` import | `fixtures.py` |
| `nix_executable`, `qemu_executable`, `ssh_keygen_executable`, `ssh_executable` | Session fixtures performing executable discovery | `fixtures.py` |
| `boot_ssh_key_pair` | Session fixture generating SSH key pair for the image | `fixtures.py` |
| `ssh_forward_port` | Ephemeral port selection for QEMU user networking | `fixtures.py` |
| `boot_image_build`, `_resolve_iso_path` | Nix build invoker returning ISO paths + metadata | `fixtures.py` |
| `boot_image_iso` | Session alias to the ISO path | `fixtures.py` |
| `vm_disk_image` | Session fixture creating raw disk image | `fixtures.py` |
| `SSHKeyPair`, `BootImageBuild` dataclasses | Data containers for image/ssh metadata | `fixtures.py` |
| `write_boot_image_metadata`, `record_boot_image_diagnostic` | Metadata/diagnostic writers | `metadata.py` |
| `BootImageVM` | Controller handling QEMU lifecycle, SSH, diagnostics | `controller.py` |
| `boot_image_vm` | Session fixture wiring QEMU command and `BootImageVM` | `fixtures.py` + `controller.py` |
| `test_wait_for_unit_inactive_logs_artifacts` and related assertions | Scenario exercising escalation + diagnostics | `test_pre_nixos_vm.py` |

## Shim decision
- Use `tests/vm/conftest.py` to import and re-export fixtures as they migrate.
- Keep `tests/test_boot_image_vm.py` as the initial consumer; shrink it to imports once helpers live under `tests/vm/`.
- Preserve fixture names and scopes to avoid churn in parametrized scenarios.

## RAID/LVM residue recipe (for regression scenario)
- Pre-seed with:
  1. `mdadm --create /dev/md127 --force --raid1 --level=1 --metadata=1.2 --raid-devices=2 /dev/vdb /dev/vdc`
  2. `pvcreate /dev/md127`
  3. `vgcreate vg_residue /dev/md127`
  4. `lvcreate -n lv_residue -l 100%FREE vg_residue`
  5. `echo residue-marker >/dev/vg_residue/lv_residue && sync`
- Expected post-`pre-nixos` assertions:
  - `/dev/md127` absent and no RAID members active.
  - VG `vg_residue` and LV `lv_residue` removed, including the sentinel content.
  - `lsblk`, `mdadm --detail --scan`, and `blkid` outputs show clean devices.
- The command list and verification scaffolding live in `tests/vm/cleanup_plan.py`.

## Commands executed (discovery)
- `rg "@pytest.fixture" tests/test_boot_image_vm.py`
- `rg "^class" tests/test_boot_image_vm.py`
- `sed -n '1,200p' tests/test_boot_image_vm.py`
- `sed -n '200,520p' tests/test_boot_image_vm.py`
- `sed -n '520,760p' tests/test_boot_image_vm.py`
- `sed -n '2480,2640p' tests/test_boot_image_vm.py`
